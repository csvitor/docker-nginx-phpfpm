version: "3"
services: 
  php7fpm:
    build: php7fpm
    container_name: php7fpm
    ports:
     - 9000:9000
    volumes: 
     - ./src:/var/www/html
    env_file:
      - .env
    links:
      - mariadb
      - "redis-session"
      - elasticsearch
    networks: 
     - web-net
  nginx:
    build: nginx
    container_name: nginx
    volumes:
      - ./.docker/log/nginx:/var/log/nginx
      - ./src:/var/www/html
    env_file:
      - .env
    ports:
      - "80:80"
      - "443:443"
    links:
      - php7fpm
    networks: 
     - web-net
  mariadb:
    image: mariadb:10.4
    container_name: "db-mariadb"
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    ports:
      - '3306:3306'
    volumes: 
      - "./.docker/database:/var/lib/mysql"
    env_file:
      - .env
    networks: 
     - web-net
    
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: "phpmyadmin-csvitor"
    links:
        - mariadb
    ports:
        - 8080:80
    environment:
        - PMA_ARBITRARY=1
    networks: 
     - web-net

  redis-session:
    image: redis
    ports:
     - 6379
    networks:
      - web-net
  mailhog:
    image: mailhog/mailhog
    container_name: "mailhog-csvitor"
    ports:
      - 1025:1025
      - 8025:8025
    networks: 
     - web-net
  # Elasticsearch Docker Images: https://www.docker.elastic.co/
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
    container_name: elasticsearch
    environment:
      - xpack.security.enabled=false
      - discovery.type=single-node
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    cap_add:
      - IPC_LOCK
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
      - 9300:9300
    networks: 
     - web-net

volumes:
  elasticsearch-data:
    driver: local

networks:
   web-net:
     driver: bridge
